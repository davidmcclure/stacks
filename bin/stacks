#!/usr/bin/env python


import click
import os

from sqlalchemy.sql import func, text
from tabulate import tabulate
from blessings import Terminal

from stacks import session
from stacks.ext import Corpus as ExtCorpus
from stacks.metadata.models import Text


term = Terminal()


@click.group()
def cli():
    pass


@cli.command()
@click.argument('corpus')
@click.argument('identifier')
def get_path(corpus, identifier):

    """
    Translate a corpus / identifier pair into a JSON path. If a corresponding
    JSON file exists, print the path in green, otherwise red.
    """

    ext_corpus = ExtCorpus.from_env()

    path = ext_corpus.text_path(corpus, identifier)

    if os.path.isfile(path):
        print(term.green(path))

    else:
        print(term.red(path))


@cli.command()
def count():

    """
    Count all texts.
    """

    print(Text.query.count())


@cli.command()
@click.argument('facet', type=click.Choice(['corpus', 'year']))
@click.option('--n', type=int, default=30)
def count_by(facet, n):

    """
    Count texts, faceting on a given field.
    """

    col = getattr(Text, facet)

    query = (
        session
        .query(col, func.count(Text.id).label('count'))
        .group_by(col)
        .order_by(text('count DESC'))
        .limit(n)
    )

    table = tabulate(
        query.all(),
        headers=[facet, 'count'],
    )

    print(table)


if __name__ == '__main__':
    cli()
